{% extends 'core/base.html' %}
{% block title %}Buscador EFP{% endblock %}

{% block content %}
<div class="kpi-card mb-4">
    <form method="get" class="d-flex gap-2">
        <input type="text" name="q" class="form-control form-control-lg" placeholder="Escribe el grupo o producto (Ej: Tos, Ibuprofeno...)" value="{{ query }}">
        <button type="submit" class="btn btn-success btn-lg px-4"><i class="fas fa-search"></i></button>
    </form>
</div>

{% if resultados %}
    <h5 class="mb-3">Resultados encontrados: {{ resultados.count }}</h5>
    {% for row in resultados %}
    <div class="card border-success mb-3 shadow-sm">
        <div class="card-header bg-success text-white fw-bold d-flex justify-content-between">
            <span><i class="fas fa-trophy me-2"></i> Recomendacion: {{ row.producto_recomendado }}</span>
            <span>Margen: {{ row.margen_pct }}%</span>
        </div>
        <div class="card-body">
            <h5 class="card-title text-muted mb-3">{{ row.nombre_grupo }}</h5>
            <div class="row text-center">
                <div class="col-4 border-end">
                    <small class="text-muted">PVP</small>
                    <div class="fs-4 fw-bold">€{{ row.pvp_medio }}</div>
                </div>
                <div class="col-4 border-end">
                    <small class="text-muted">Ahorro Potencial</small>
                    <div class="fs-4 fw-bold text-success">€{{ row.ahorro_potencial|floatformat:0 }}</div>
                </div>
                <div class="col-4">
                    <small class="text-muted">Margen</small>
                    <div class="fs-4 fw-bold text-secondary">{{ row.margen_pct }}%</div>
                </div>
            </div>
            <div class="alert alert-warning mt-3 mb-0 py-2">
                <small><i class="fas fa-exclamation-triangle"></i> <strong>Sustituye a:</strong></small>
                <div class="mt-1 small text-muted">
                    {% for comp in row.get_competidores_stats %}
                        {% if not comp.es_campeon %}
                            <span class="badge bg-light text-dark border me-1 mb-1">{{ comp.nombre }}</span>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endif %}
{% endblock %}
